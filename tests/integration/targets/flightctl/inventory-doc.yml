# ---
# - name:: Test that flightctl inventory plugin is described correctly in ansible-doc
#   hosts: localhost
#   gather_facts: false
#   vars:
#     required_phrases:
#       - "FLIGHTCTL.CORE.FLIGHTCTL"
#       - "Returns Ansible inventory using Flight Control as source"
#       - "ADDED IN: version"
#       - "OPTIONS (= is mandatory):"
#       - "NAME: flightctl"
#   block:
#     - name: Run ansible-doc to get plugin help text
#       ansible.builtin.command: ansible-doc -t inventory flightctl.core.flightctl
#       register: doc_output
#       changed_when: false

#     - name: Assert all required phrases are present in ansible-doc output
#       ansible.builtin.assert:
#         that: >
#           {{ required_phrases | map('in', doc_output.stdout) | list | min }}
#         fail_msg: "One or more expected phrases are missing in ansible-doc output"

#     - name: Show ansible-doc output for debug
#       ansible.builtin.debug:
#         var: doc_output.stdout
---
- name: Test Get Resource Sync Info
  vars:
    resource_sync_name: ansible-integration-test-resource-sync
    connection_info: &connection_info
      flightctl_token: "{{ flightctl_token | default(omit)}}"
      flightctl_host: "{{ flightctl_host }}"
      flightctl_validate_certs: False
  block:
  - name: Create a test resource sync
    flightctl.core.flightctl_resource:
      <<: *connection_info
      kind: ResourceSync
      name: "{{ resource_sync_name }}"
      resource_definition:
        spec:
          repository: flightctl
          path: /examples/fleet.yaml
          targetRevision: main

  - name: Get test resource sync
    flightctl.core.flightctl_resource_info:
      <<: *connection_info
      kind: ResourceSync
      name: "{{ resource_sync_name }}"
    register: resource_sync_result

  - name: Assert that resource sync info was fetched
    ansible.builtin.assert:
      that:
        - resource_sync_result is success
        - resource_sync_result.result.data[0].metadata.name == "ansible-integration-test-resource-sync"

  always:
    - name: Delete test resource sync
      flightctl.core.flightctl_resource:
        <<: *connection_info
        kind: ResourceSync
        name: "{{ resource_sync_name }}"
        state: absent
